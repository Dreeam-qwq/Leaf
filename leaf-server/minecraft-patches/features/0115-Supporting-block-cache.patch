From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Taiyou06 <kaandindar21@gmail.com>
Date: Sat, 8 Feb 2025 05:32:30 +0100
Subject: [PATCH] Supporting block cache


diff --git a/net/minecraft/world/entity/Entity.java b/net/minecraft/world/entity/Entity.java
index 3beb2b05265cf274f52170018cc22243b06c05e9..d9861d2abc3f37e47b2127eb032a8a83fcaeba3e 100644
--- a/net/minecraft/world/entity/Entity.java
+++ b/net/minecraft/world/entity/Entity.java
@@ -1082,19 +1082,38 @@ public abstract class Entity implements SyncedDataHolder, Nameable, EntityAccess
         return this.mainSupportingBlockPos.isPresent() && this.mainSupportingBlockPos.get().equals(pos);
     }
 
-    protected void checkSupportingBlock(boolean onGround, @Nullable Vec3 movement) {
+    // Leaf - Cache for supporting block state
+    private boolean canSkipSupportingBlockSearch = false;
+    private BlockState cachedSupportingBlockState = null;
+    protected void checkSupportingBlock(boolean onGround, Vec3 movement) {
+        // Leaf - Skip full check if no movement and cache is valid
+        if (movement == null || (movement.x == 0 && movement.z == 0 && movement.y == 0)) {
+            if (canSkipSupportingBlockSearch) {
+                return;
+            }
+        } else {
+            // Leaf - Invalidate cache on movement
+            canSkipSupportingBlockSearch = false;
+            cachedSupportingBlockState = null;
+        }
+        // Leaf - Original checkSupportingBlock logic
         if (onGround) {
             AABB boundingBox = this.getBoundingBox();
             AABB aabb = new AABB(boundingBox.minX, boundingBox.minY - 1.0E-6, boundingBox.minZ, boundingBox.maxX, boundingBox.minY, boundingBox.maxZ);
-            Optional<BlockPos> optional = this.level.findSupportingBlock(this, aabb);
+            Optional<BlockPos> optional = this.level().findSupportingBlock(this, aabb);
             if (optional.isPresent() || this.onGroundNoBlocks) {
+                // Leaf - Cache the block state if found
+                if (optional.isPresent()) {
+                    BlockPos pos = optional.get();
+                    cachedSupportingBlockState = this.level().getBlockState(pos);
+                    canSkipSupportingBlockSearch = true;
+                }
                 this.mainSupportingBlockPos = optional;
             } else if (movement != null) {
                 AABB aabb1 = aabb.move(-movement.x, 0.0, -movement.z);
-                optional = this.level.findSupportingBlock(this, aabb1);
+                optional = this.level().findSupportingBlock(this, aabb1);
                 this.mainSupportingBlockPos = optional;
             }
-
             this.onGroundNoBlocks = optional.isEmpty();
         } else {
             this.onGroundNoBlocks = false;
@@ -1103,6 +1122,11 @@ public abstract class Entity implements SyncedDataHolder, Nameable, EntityAccess
             }
         }
     }
+    // Leaf - Helper method to get cached supporting block state
+    @Nullable
+    public BlockState getCachedSupportingBlock() {
+        return canSkipSupportingBlockSearch ? cachedSupportingBlockState : null;
+    }
 
     public boolean onGround() {
         return this.onGround;
